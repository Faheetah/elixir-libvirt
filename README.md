# Libvirt

A simple Libvirt RPC client in pure Elixir.

Note: there are a few caveats to using this library:

* It is in a pre-release state, while basic functionality appears to work the library may be prone to bugs pre-1.0.
* It is a personal project of mine and may never be production ready, however demonstrates some useful concepts with Elixir.
* While there is a pooled connection option (Shared), only Direct is currently supported, and Shared may be dropped in the future.
* The XDR translations are incomplete, or in other words, if you find a bad value on send or receive, it may be a type missing from Libvirt.RPC.XDR, I have been adding these on an as needed basis.
* I don't understand flags, and they appear to be used in some places, but unused in many, but flags can be passed in directly with the struct.
* The API is a bit verbose as it is a direct 1:1 of the Libvirt code, this is intentional.
* Streams may be unreliable, though appear to work fine in concurrent environments with Direct mode, however Direct mode will instantiate a new TCP session per connection but due to Elixir's concurrency model this should not be that big of a problem.
* Console is NOT supported due to needing bidirectional streams. This was not initially accounted for and will need a reimplementation of stream handling.

## Installation

This repo is not currently available in Hex as it is an unstable version. Hex can pull directly from git or local filesystem as an alternative installation method.

## Use

See `basic_test.exs` and `download_test.exs` for some working examples.

Start a connection

```
iex(1)> {:ok, socket} = Libvirt.connect("colosseum.sudov.im")
{:ok, #Port<0.19>}
```

If an error occurs, it will be returned back. This includes errors directly from Libvirt.

```
iex(2)> Libvirt.connect_list_all_domains(socket, %{})
** (throw) "Key 'need_results' not found in map keys: []"
    (libvirt 0.1.1) lib/libvirt/rpc/xdr.ex:121: Libvirt.RPC.XDR.translate/3
    (libvirt 0.1.1) lib/libvirt/rpc/xdr.ex:13: anonymous fn/2 in Libvirt.RPC.XDR.encode/2
    (elixir 1.12.2) lib/enum.ex:1582: Enum."-map/2-lists^map/1-0-"/2
    (libvirt 0.1.1) lib/libvirt/rpc/xdr.ex:11: Libvirt.RPC.XDR.encode/2
    (libvirt 0.1.1) lib/libvirt/libvirt.ex:39: Libvirt.connect_list_all_domains/2
iex(2)> Libvirt.connect_list_all_domains(socket, %{"need_results" => 1})
** (throw) "unable to parse flag: nil"
    (libvirt 0.1.1) lib/libvirt/rpc/xdr.ex:26: Libvirt.RPC.XDR.encode/2
    (libvirt 0.1.1) lib/libvirt/libvirt.ex:39: Libvirt.connect_list_all_domains/2
```

Make a call to a Libvirt function by passing the socket as the first argument, and an optional payload as the second.

```
iex(2)> Libvirt.connect_list_all_domains(socket, %{"need_results" => 1, "flags" => 0})
{:ok, %{"domains" => [], "ret" => 0}}
```

## Documentation

As the function calls are generated by a macro, documentation will be generated with exdoc. The internal IEX help can also be used, as specs are included with all of the generated calls.

```
iex(3)> h Libvirt.connect_list_all_domains

                 def connect_list_all_domains(socket, payload)

  @spec connect_list_all_domains(pid(), %{
          need_results: integer(),
          flags: integer()
        }) :: %{
          domains: [%{name: String.t(), uuid: String.t()}],
          ret: integer()
        }

Calls connect_list_all_domains using Libvirt RPC
```

## Development

Install libvirt for the sandbox environment.

### Ubuntu

```
apt install libvirt-daemon libvirt-daemon-system libvirt-daemon-system-systemd
systemctl start libvirtd-tcp.socket
```

Libvirt will listen locally on 16509. The Libvirt mock environment can be accessed with test:///default using localhost.
